import React, { Component } from 'react';
import { bindActionCreators } from 'redux';
import { connect } from 'react-redux';

import * as authActions from 'actions/auth';
import Spinner from 'components/Spinner';
import api from 'helpers/api';

@connect(
    state => ({
        auth: state.auth,
        config: state.config
    }),
    dispatch => ({
        authActions: bindActionCreators(authActions, dispatch)
    })
)
export default class App extends Component {
    componentWillMount() {
        this.checkAuth();
    }

    componentDidUpdate() {
        if(this.props.auth.oauthStarted && !this._popoutWindow) {
            this._popoutWindow = window.open(api.getAuthUrl(), this.props.title, 'width=450,height=600');
            if(this._popoutWindow) {
                this._popoutWindow.onbeforeunload = this.popoutClosed.bind(this);
                window.addEventListener('unload', this.closeWindow);
            }
        }
    }

    closeWindow() {
        this._popoutWindow && this._popoutWindow.close();
        window.removeEventListener('unload', this.closeWindow);
    }

    checkAuth() {
        const {
            auth,
            config
        } = this.props;

        if(!auth.loaded || !auth.user) {
            this.props.authActions.init(config);
            this.props.authActions.load();
        }
    }

    popoutClosed() {
        window.setTimeout(() => {
            this.checkAuth();
        }, 1000);
    }

    render() {
        const {
            auth,
            children
        } = this.props;

        if(auth.oauthStarted || (!auth.loaded && auth.loading) || !auth.user) {
            return (
                <div className="container container--app-load">
                    {auth.oauthStarted ? (
                        <p className="info">Opening popup to authenticate with Trakt.tv</p>
                    ) : !auth.loaded && auth.loading ? (
                        <Spinner size="large" />
                    ) : (
                        <div>
                            <svg version="1" xmlns="http://www.w3.org/2000/svg" viewBox="571.2 45.187 777.591 777.6"><g fill="#FFF"><path d="M1115.485 302.996c-74.33-8.847-145.835-13.16-218.635-13.16-72.8 0-144.297 4.313-218.584 13.16-23.854 2.877-45.282 24.14-47.78 47.425-11.145 104.978-11.145 211.43 0 316.398 2.498 23.302 23.935 44.65 47.824 47.59 74.26 8.77 145.748 13.028 218.55 13.028 72.8 0 144.295-4.26 218.634-13.038 23.88-2.93 45.343-24.287 47.84-47.598 11.016-104.94 11.007-211.396-.01-316.38-2.496-23.275-23.958-44.547-47.84-47.424zm35.632 362.5c-1.9 17.66-18.904 34.456-37.11 36.703-73.802 8.717-144.85 12.933-217.156 12.933-72.316 0-143.328-4.216-217.08-12.934-18.204-2.248-35.182-19.035-37.073-36.695-11.05-104.104-11.042-209.676 0-313.78 1.892-17.616 18.853-34.343 37.022-36.537 73.802-8.796 144.822-13.072 217.13-13.072 72.31 0 143.347 4.276 217.158 13.072 18.222 2.194 35.208 18.93 37.1 36.53 10.94 104.12 10.94 209.7.01 313.778z"/><path d="M1113.256 321.537c-73.57-8.77-144.348-13.028-216.396-13.028-72.05 0-142.81 4.258-216.363 13.02-14.922 1.797-29.903 16.502-31.44 30.86-11.008 103.673-11.008 208.796 0 312.44 1.537 14.395 16.51 29.17 31.432 31.02 73.525 8.682 144.296 12.898 216.362 12.898 72.058 0 142.81-4.217 216.337-12.89 14.98-1.85 30.022-16.616 31.552-31.01 10.896-103.663 10.896-208.786 0-312.44-1.53-14.36-16.53-29.073-31.486-30.87zm19.285 342.015c-.95 8.813-11.456 18.956-20.805 20.105-73.017 8.623-143.294 12.805-214.876 12.805-71.584 0-141.888-4.182-214.904-12.805-9.306-1.15-19.742-11.318-20.685-20.13-10.91-102.782-10.91-207.033 0-309.832.935-8.77 11.38-18.835 20.686-19.967 73.043-8.69 143.33-12.926 214.895-12.926s141.87 4.234 214.946 12.935c9.323 1.132 19.786 11.206 20.728 19.967 10.8 102.78 10.8 207.04.017 309.848z"/><path d="M1124.125 354.49c-.69-4.916-8.026-11.74-13.313-12.372-72.73-8.666-142.733-12.882-213.952-12.882-71.23 0-141.178 4.207-213.866 12.873-5.28.63-12.606 7.438-13.297 12.328-.01.044-.01.096-.018.14-10.853 102.21-10.853 205.847 0 308.032 0 .034.008.06.008.104.647 4.977 7.932 11.897 13.245 12.537 72.714 8.59 142.68 12.77 213.935 12.77 71.246 0 141.17-4.164 213.823-12.752 5.738-.7 12.806-7.896 13.444-12.44.01-.044.018-.096.018-.147 10.74-102.22 10.74-205.873.01-308.04-.028-.054-.028-.098-.037-.15zm-8.096 307.11c-.605 1.59-4.407 5.305-6.325 5.556-72.3 8.536-141.938 12.69-212.838 12.69-70.926 0-140.58-4.163-212.96-12.708-1.536-.216-5.528-3.862-6.106-5.573-10.765-101.485-10.765-204.404 0-305.925.554-1.59 4.44-5.192 6.16-5.4 72.37-8.63 142.008-12.812 212.9-12.812 70.89 0 140.57 4.19 212.983 12.82 1.736.21 5.642 3.83 6.186 5.427 10.618 101.476 10.618 204.395 0 305.925zM1249.725 383.262c25.756 0 46.717-20.952 46.717-46.717 0-25.756-20.96-46.708-46.717-46.708-25.747 0-46.7 20.952-46.7 46.708 0 25.765 20.954 46.717 46.7 46.717zm-12.7-73.19l15.137 22.127c.786 1.166 2.064 1.788 3.378 1.788.812 0 1.606-.233 2.315-.718 1.866-1.278 2.342-3.827 1.07-5.693l-15.145-22.145c3.55-1.72 7.542-2.687 11.76-2.687.275 0 .552.008.846.017 12.104 2.376 21.972 11.13 25.91 22.61.243 1.47.39 2.973.39 4.502 0 14.956-12.174 27.14-27.146 27.14-14.956 0-27.13-12.175-27.13-27.14-.01-7.792 3.3-14.85 8.614-19.802zm-12.684 3.258c-2.643 4.94-4.138 10.584-4.138 16.562 0 19.475 15.846 35.33 35.33 35.33 7.74 0 14.91-2.507 20.727-6.75-6.317 7.64-15.873 12.512-26.534 12.512-18.974 0-34.413-15.44-34.413-34.43 0-8.95 3.412-17.108 9.028-23.224zM1247.548 620.5c-25.756 0-46.717 20.96-46.717 46.707 0 25.756 20.962 46.716 46.718 46.716 25.747 0 46.7-20.96 46.7-46.716.008-25.747-20.944-46.708-46.7-46.708zm0 81.146c-18.982 0-34.43-15.44-34.43-34.43 0-8.935 3.43-17.1 9.054-23.225-2.644 4.95-4.14 10.585-4.14 16.58 0 19.467 15.847 35.32 35.33 35.32 7.74 0 14.904-2.514 20.736-6.747-6.34 7.62-15.88 12.503-26.55 12.503zm5.806-13.954c-14.964 0-27.146-12.174-27.146-27.13 0-14.973 12.174-27.155 27.146-27.155.27 0 .545.018.82.018 9.082 1.788 16.9 7.136 21.903 14.55l-24.114 8.734c-2.134.76-3.23 3.11-2.453 5.227.596 1.676 2.16 2.713 3.844 2.713.46 0 .925-.087 1.392-.25l25.107-9.09c.087.242.173.483.25.734.243 1.46.38 2.964.38 4.51.01 14.965-12.165 27.138-27.13 27.138zM1206.102 425.157h18.672c3.403 0 6.16-2.756 6.16-6.144 0-3.396-2.757-6.143-6.16-6.143h-18.672c-3.396 0-6.143 2.747-6.143 6.143 0 3.38 2.755 6.144 6.142 6.144zM1293.357 412.862h-18.672c-3.395 0-6.15 2.748-6.15 6.144 0 3.387 2.756 6.143 6.15 6.143h18.672c3.396 0 6.15-2.757 6.15-6.144.002-3.388-2.754-6.144-6.15-6.144zM1293.357 454.3H1206.1c-3.395 0-6.142 2.748-6.142 6.144 0 3.403 2.747 6.134 6.143 6.134h87.257c3.396 0 6.15-2.73 6.15-6.134.002-3.397-2.754-6.144-6.15-6.144zM1293.357 495.737H1206.1c-3.395 0-6.142 2.756-6.142 6.15 0 3.405 2.747 6.136 6.143 6.136h87.257c3.396 0 6.15-2.73 6.15-6.135.002-3.395-2.754-6.15-6.15-6.15zM1293.357 537.184H1206.1c-3.395 0-6.142 2.756-6.142 6.134 0 3.404 2.747 6.152 6.143 6.152h87.257c3.396 0 6.15-2.748 6.15-6.152.002-3.38-2.754-6.134-6.15-6.134zM1293.357 578.63H1206.1c-3.395 0-6.142 2.73-6.142 6.134s2.747 6.135 6.143 6.135h87.257c3.396 0 6.15-2.73 6.15-6.136s-2.754-6.134-6.15-6.134z"/><path d="M1339.27 254.508l-.06-.656c-.33-5.098-4.424-9.22-9.59-9.53-31.995-1.927-64.31-3.628-96.164-5.072-5.01-7.74-11.448-14.273-18.887-19.31l125.45-156.6c2.127-2.652 1.687-6.515-.95-8.64-2.66-2.125-6.52-1.693-8.63.942l-126.81 158.285c-8.398-3.663-17.582-5.625-27.07-5.625-4.51 0-8.96.432-13.287 1.287l-71.23-154.38c-1.416-3.076-5.07-4.423-8.146-2.998-3.067 1.417-4.424 5.063-3.007 8.147l70.485 152.754c-11.345 4.527-21.34 12.096-28.892 22.1-42.397-1.148-84.785-1.865-126.093-2.124-12.07-.078-24.313-.112-36.4-.112-12.07 0-24.32.035-36.392.112-108.2.657-220.32 4.433-333.22 11.24-5.184.312-9.27 4.433-9.606 9.54l-.053.648c-3.31 39.053-18.87 247 .06 506.21.372 5.113 4.467 9.157 9.582 9.477 19.285 1.175 39.13 2.298 59.14 3.335v32.582c0 5.65 4.59 10.238 10.24 10.238h600.497c5.658 0 10.255-4.58 10.255-10.238V773.54c20-1.036 39.848-2.16 59.15-3.335 5.105-.32 9.2-4.363 9.572-9.478 18.923-259.21 3.37-467.165.054-506.22zm-162.708-25.176c14.48 0 27.916 6.662 36.694 17.816-23.64-1.002-47.47-1.858-71.168-2.592 8.77-9.634 21.16-15.224 34.474-15.224zm73.448 566.524H669.99v-29.808c84.473 4.07 169.473 6.367 253.636 6.877 12.07.086 24.227.13 36.374.13 12.156 0 24.305-.044 36.374-.13 84.163-.51 169.154-2.808 253.636-6.877v29.808zm69.44-45.86c-107.18 6.41-215.836 10.004-323.145 10.652-24.08.146-48.514.146-72.594 0-107.29-.648-215.964-4.242-323.16-10.653-16.84-240.2-3.654-439.456-.07-485.767 109.54-6.445 218.257-10.04 323.25-10.67 12.035-.07 24.243-.112 36.27-.112 12.045 0 24.245.035 36.28.112 39.675.233 80.37.907 121.107 2.004.777.372 1.64.596 2.53.622l8.21.242c32.606.916 65.663 2.125 98.184 3.568l8.2.363c.104 0 .182.008.285.008h.01c.81 0 1.58-.164 2.297-.44 27.32 1.253 54.942 2.696 82.4 4.312 3.594 46.31 16.796 245.566-.052 485.758z"/></g><g fill="#FFF"><path d="M1012.41 381.778l-37.168 37.166c-78.806-31.66-172.41-15.486-236.075 48.18l22.024 22.024c51.277-50.932 124.922-66.417 189.62-45.77l-25.466 25.466c-49.556-10.324-103.24 3.786-141.784 42.673l22.025 22.025c25.122-25.122 58.503-37.51 91.883-36.48l-37.854 37.856c-11.7 4.474-22.368 11.356-32.005 20.993l5.505 5.507-39.92 39.23 12.046 12.045 219.215-218.87-12.045-12.044zM871.66 599.96l22.023 22.022 22.025-22.023c-12.045-12.39-32.004-12.39-44.05 0zM881.982 560.73c19.616-3.788 40.952 2.063 56.094 17.204L960.1 555.91c-13.42-13.42-30.284-22.025-47.49-25.466L881.98 560.73zM937.732 504.978c16.175 6.195 31.317 15.487 44.394 28.564l22.024-22.025c-12.732-12.733-27.187-23.057-42.674-30.284l-23.744 23.745zM1007.592 435.118L984.88 457.83c14.796 8.26 28.905 18.584 41.64 31.317l22.023-22.025c-12.732-12.388-26.498-23.056-40.95-32.004z"/></g></svg>
                            <p>{!navigator.onLine ? 'You are offline' : 'Failed to connect to Trakt.tv'}</p>
                        </div>
                    )}
                </div>
            );
        } else {
            return children;
        }
    }
}
